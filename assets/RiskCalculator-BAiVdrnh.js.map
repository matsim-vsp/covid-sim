{"version":3,"file":"RiskCalculator-BAiVdrnh.js","sources":["../../src/views/RiskCalculator.vue"],"sourcesContent":["<template lang=\"pug\">\n.rcc\n  .banner\n    h2 VSP / Technische Universität Berlin\n    h3 COVID-19 Analysis Portal\n\n  .center-area(v-if=\"yaml.multipliers\")\n\n    h2 {{ $t('risk-calculator') }}\n    h5(:style=\"{marginBottom: '1rem', color: '#596'}\") {{ $t('released')}} {{ this.calcId}}\n\n    h3.badpage(v-if=\"badPage\") {{ $t('badpage') }}\n\n    .goodpage(v-else)\n      p(v-if=\"yaml.description\") {{ yaml.description}}\n\n      h3: b {{ $t('explore-scenarios') }}:\n      .measures\n        .measure(v-for=\"m in Object.keys(yaml.scenarios)\" :key=\"m\")\n          button.button.is-danger.is-outlined.is-small(@click=\"handleScenario(m)\") {{ m }}\n\n      p {{ selectedScenario ? selectedScenario.description : $t('try-combos') }}\n\n  h3.center-area.sticky: b {{ $t('estimated-risk') }}:&nbsp;\n    span.greenbig(:style=\"{fontSize: '2.5rem', fontWeight: 'bold', color: '#596'}\") {{ adjustedR.toFixed(1) }}%\n\n  .center-area(v-if=\"yaml.multipliers\")\n    .option-groups\n      //- multipliers\n      .option-group(v-for=\"group in multipliers\" :key=\"`add+${group}`\")\n        h4 {{ group }}\n        .description {{ yaml.multipliers[group].description }}\n\n        b-slider.slider(\n            :value=\"0\"\n            v-model=\"sliders[group]\"\n            :min=\"0\" :max=\"lookup[group].length-1\"\n            :tooltip=\"false\"\n            size=\"is-large\"\n            @input=\"handleFactorButton(group)\"\n        )\n            b-slider-tick(v-for=\"tick,i in lookup[group]\" :key=\"tick.title\" :value=\"i\")\n\n        p.slider-label {{ lookup[group][sliders[group]].title}}\n\n\n      //- divisors\n      .option-group(v-for=\"group in divisors\" :key=\"group\")\n        h4 {{ group }}\n        .description {{ yaml.divisors[group].description }}\n\n        b-slider.slider(\n            :value=\"0\"\n            v-model=\"sliders[group]\"\n            :min=\"0\" :max=\"lookup[group].length-1\"\n            :tooltip=\"false\"\n            size=\"is-large\"\n            @input=\"handleDivFactorButton(group)\"\n        )\n            b-slider-tick(v-for=\"tick,i in lookup[group]\" :key=\"tick.title\" :value=\"i\")\n\n        p.slider-label {{ lookup[group][sliders[group]].title}}\n\n\n      br\n\n      h3(v-if=\"yaml.notes\"): b {{$t('remarks') }}:\n\n      ul(v-if=\"yaml.notes\")\n        li.notes-item(v-for=\"line in yaml.notes\" v-html=\"parseMarkdown(line)\")\n\n</template>\n\n<script lang=\"ts\">\nconst i18n = {\n  messages: {\n    en: {\n      'risk-calculator': 'Personal Risk Calculator',\n      badpage: 'That page not found, sorry!',\n      released: 'Released',\n      'estimated-risk': 'Estimated Infection Risk',\n      'explore-scenarios': 'Explore typical scenarios',\n      'try-combos': '...or try different combinations below.',\n      remarks: 'Remarks',\n    },\n    de: {\n      'risk-calculator': 'Personalrisiko Rechner',\n      badpage: 'Seite wurde nicht gefunden.',\n      released: 'Veröffentlicht',\n      'explore-scenarios': 'Typische Szenarien erforschen',\n      'try-combos': '...oder versuchen Sie verschiedene Kombinationen unten.',\n      'estimated-risk': 'Geschätztes Infektionsrisiko',\n      remarks: 'Bemerkungen',\n    },\n  },\n}\n\nimport YAML from 'yaml'\nimport MarkdownIt from 'markdown-it'\n\nimport { PUBLIC_SVN } from '@/Globals'\n\nconst markdownParser = new MarkdownIt({\n  html: true,\n  linkify: true,\n  typographer: true,\n})\n\ntype RiskYaml = {\n  description: string\n  calibrationParam: number\n  notes: string[]\n  multipliers: {\n    [measure: string]: {\n      description: string\n      options: { [choice: string]: any }[]\n    }\n  }\n  divisors: {\n    [measure: string]: {\n      description: string\n      options: { [choice: string]: any }[]\n    }\n  }\n  scenarios: {\n    [scenario: string]: {\n      description: string\n      presets: { [measure: string]: any }[]\n    }\n  }\n}\n\nimport { defineComponent } from 'vue'\nimport type { PropType } from 'vue'\n\nexport default defineComponent({\n  name: 'RiskCalculator',\n  i18n,\n  components: {},\n  props: {},\n\n  data() {\n    return {\n      calcId: '',\n\n      yaml: {\n        description: '',\n        calibrationParam: 0.075,\n        multipliers: {},\n        divisors: {},\n        scenarios: {},\n        notes: [],\n      } as RiskYaml,\n\n      badPage: false,\n      selectedScenario: {} as any,\n\n      finalR: 0,\n      adjustedR: 0,\n\n      lookup: {} as { [measure: string]: { title: string; value: number }[] },\n      sliders: {} as { [measure: string]: number },\n      factors: {} as { [measure: string]: number },\n      divFactors: {} as { [measure: string]: number },\n    }\n  },\n\n  mounted() {\n    this.buildPageForURL()\n  },\n\n  computed: {\n    multipliers() {\n      return Object.keys(this.yaml.multipliers)\n    },\n    divisors() {\n      return Object.keys(this.yaml.divisors)\n    },\n  },\n\n  watch: {\n    $route() {\n      this.buildPageForURL()\n    },\n  },\n\n  methods: {\n    parseMarkdown(text: string) {\n      return markdownParser.render(text)\n    },\n\n    async buildPageForURL() {\n      this.badPage = false\n\n      this.calcId = this.$route.params.rcalc\n\n      const lang = this.$i18n.locale //  === 'de' ? '.de' : ''\n      const url = PUBLIC_SVN + `risk-calculator/${this.calcId}.${lang}.yaml`\n\n      let responseText = ''\n\n      try {\n        const response = await fetch(url)\n        responseText = await response.text()\n      } catch (e) {\n        console.error(e)\n      }\n\n      // maybe .de. doesn't exist, fallback .en.:\n      if (!responseText && url.indexOf('.de.') > -1) {\n        console.warn('no', url, 'falling back to .en.')\n        const en_url = url.replace('.de.', '.en.')\n        console.log(en_url)\n        try {\n          const response = await fetch(en_url)\n          responseText = await response.text()\n        } catch (e) {\n          console.error(e)\n        }\n      }\n\n      if (!responseText) {\n        this.badPage = true\n        return\n      }\n\n      this.yaml = YAML.parse(responseText)\n      this.buildUI()\n      this.updateR()\n    },\n\n    async handleDivFactorButton(measure: string) {\n      const idx = this.sliders[measure]\n      const option = this.lookup[measure][idx]\n      this.divFactors[measure] = option.value\n      this.updateR()\n      this.$forceUpdate()\n    },\n\n    async handleFactorButton(measure: string) {\n      const idx = this.sliders[measure]\n      const option = this.lookup[measure][idx]\n      this.factors[measure] = option.value\n      this.updateR()\n      this.$forceUpdate()\n    },\n\n    async handleScenario(scenario: string) {\n      this.selectedScenario = this.yaml.scenarios[scenario]\n      for (const measure of Object.keys(this.selectedScenario.presets) as any) {\n        const title = this.selectedScenario.presets[measure]\n\n        //@ts-ignore:\n        const value = this.lookup[measure].find((a: any) => a.title === title).value\n\n        console.log(measure, title, value)\n\n        if (this.multipliers.indexOf(measure) > -1) this.factors[measure] = value\n        if (this.divisors.indexOf(measure) > -1) this.divFactors[measure] = value\n\n        // find this entry for the slider!\n        for (let i = 0; i < this.lookup[measure].length; i++) {\n          const choice = this.lookup[measure][i]\n          if (choice.title === title) {\n            this.sliders[measure] = i\n            break\n          }\n        }\n      }\n\n      this.updateR()\n      this.$forceUpdate()\n    },\n\n    updateR() {\n      let r = this.yaml.calibrationParam\n\n      // multiplicative factors\n      for (const factor of Object.values(this.factors)) r *= factor\n      // divisors factors, already 1/x\n      for (const factor of Object.values(this.divFactors)) r *= factor\n      // exp result\n      r = 1.0 - Math.exp(-1.0 * r)\n\n      // fancy!\n      this.finalR = Math.min(99, r * 100.0) // percentage\n      this.animateTowardNewRValue()\n    },\n\n    animateTowardNewRValue() {\n      const diff = this.finalR - this.adjustedR\n      const step = this.adjustedR + diff * 0.2\n      this.adjustedR = step\n\n      if (Math.abs(this.adjustedR - this.finalR) < 0.01) {\n        this.adjustedR = this.finalR\n      } else {\n        setTimeout(this.animateTowardNewRValue, 16)\n      }\n    },\n\n    buildUI() {\n      // multiplicative factors\n      for (const measureName of Object.keys(this.yaml.multipliers)) {\n        const measures = this.yaml.multipliers[measureName]\n        this.lookup[measureName] = []\n\n        for (let i = 0; i < measures.options.length; i++) {\n          const option = measures.options[i]\n          const title = Object.keys(option)[0]\n          const value = option[title]\n\n          Number.isNaN\n          if (!isNaN(value)) {\n            this.lookup[measureName].push({ title, value })\n\n            // first?\n            if (this.yaml.multipliers[measureName].options === undefined) {\n              this.factors[measureName] = value\n              this.sliders[measureName] = i // this.lookup[measureName][0].value\n            }\n          } else {\n            // user specified a default with an asterisk* after the number\n            const trimAsterisk = parseFloat(value.substring(0, value.length - 1))\n            const choice = { title, value: trimAsterisk }\n            this.lookup[measureName].push(choice)\n            this.sliders[measureName] = i\n            this.factors[measureName] = trimAsterisk\n          }\n        }\n      }\n\n      // divisors\n      for (const measureName of Object.keys(this.yaml.divisors)) {\n        const measures = this.yaml.divisors[measureName]\n        this.lookup[measureName] = []\n\n        for (let i = 0; i < measures.options.length; i++) {\n          const option = measures.options[i]\n          const title = Object.keys(option)[0]\n          const value = option[title]\n\n          if (!isNaN(value)) {\n            this.lookup[measureName].push({ title, value: 1.0 / value })\n\n            // first?\n            if (this.yaml.divisors[measureName].options === undefined) {\n              this.divFactors[measureName] = value\n              this.sliders[measureName] = i // this.lookup[measureName][0].value\n            }\n          } else {\n            // user specified a default with an asterisk* after the number\n            const trimAsterisk = 1.0 / parseFloat(value.substring(0, value.length - 1))\n            const choice = { title, value: trimAsterisk }\n            this.lookup[measureName].push(choice)\n            this.sliders[measureName] = i // choice.value\n            this.divFactors[measureName] = trimAsterisk\n          }\n        }\n      }\n    },\n  },\n})\n</script>\n\n<style scoped lang=\"scss\">\n@use '@/styles.scss' as *;\n\n.center-area {\n  max-width: 70rem;\n  padding: 1rem 3rem 1rem 3rem;\n}\n\n.option-groups {\n  display: grid;\n  grid-template-columns: repeat(2, 1fr);\n  gap: 1rem;\n}\n\n.option-group {\n  border: solid 1px #bbf;\n  border-radius: 4px;\n  background-color: #fff;\n  padding: 0.5rem 0.5rem;\n}\n\n.measures {\n  padding: 0.5rem 0;\n  display: flex;\n  flex-direction: row;\n  flex-wrap: wrap;\n}\n\nh2 {\n  font-size: 2rem;\n}\n\nh3 {\n  font-weight: normal;\n  font-size: 1.3rem;\n  margin-bottom: -0.5rem;\n}\n\nh4 {\n  color: #596;\n  font-size: 1.2rem;\n  font-weight: bold;\n  margin: 0 0 0 0;\n  padding: 0 0;\n}\n\n.button {\n  padding: 0 0.5rem;\n  margin: 0 0.15rem 0.15rem 0;\n}\n\np {\n  margin-bottom: 1rem;\n}\n\np.factor {\n  margin: auto 0 auto 1rem;\n  color: #ccc;\n}\n\n.banner {\n  display: flex;\n  flex-direction: column;\n  padding: 4rem 3rem 1rem 3rem;\n  background-color: #1e1f2c;\n  color: white;\n  background: url(../assets/images/banner.jpg);\n  background-repeat: no-repeat;\n  background-size: cover;\n}\n\n.banner h2 {\n  margin-bottom: 0rem;\n  font-size: 1.6rem;\n  background-color: #1e1f2c;\n  line-height: 1.6rem;\n  margin-right: auto;\n}\n\n.banner h3 {\n  font-size: 1.3rem;\n  font-weight: normal;\n  margin-bottom: 0;\n  line-height: 1.4rem;\n  padding-bottom: 0.25rem;\n  background-color: #1e1f2c;\n  width: max-content;\n}\n\n.base-buttons {\n  margin-bottom: 1rem;\n}\n\n.greenbig {\n  color: #596;\n  font-weight: bold;\n  font-size: 2.5rem;\n}\n\n.notes-item {\n  list-style-type: square;\n  margin-left: 1rem;\n  margin-top: 0.5rem;\n  color: #222;\n}\n\nli.notes-item {\n  line-height: 1.3rem;\n}\n\n.description {\n  font-size: 0.85rem;\n  margin-top: 0;\n  margin-bottom: 0.25rem;\n}\n\n.sticky {\n  top: 3rem;\n  position: sticky;\n  background-color: #eee;\n  padding-top: 0;\n  padding-bottom: 0rem;\n}\n\n.slider {\n  padding: 0.5rem;\n  margin: 0rem 0rem;\n}\n\n.slider-label {\n  font-size: 0.9rem;\n  font-weight: bold;\n  color: #383ab1;\n  margin: 0 0;\n}\n\n@media only screen and (max-width: 850px) {\n  .option-groups {\n    grid-template-columns: repeat(2, 1fr);\n  }\n}\n\n@media only screen and (max-width: 640px) {\n  .banner {\n    padding: 2rem 1rem;\n  }\n\n  .center-area {\n    padding-left: 1rem;\n    padding-right: 1rem;\n  }\n\n  .option-groups {\n    grid-template-columns: repeat(1, 1fr);\n  }\n}\n</style>\n"],"names":["i18n","markdownParser","MarkdownIt","_sfc_main","defineComponent","text","lang","url","PUBLIC_SVN","responseText","e","en_url","YAML","measure","idx","option","scenario","title","value","i","r","factor","diff","step","measureName","measures","trimAsterisk","choice"],"mappings":"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"}